<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayShare : Share Your Spotify Playlist</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #ffffff;
            overflow: hidden;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #535353; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b6b6b; }
        .info-hidden .song-info { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .info-visible .song-info { opacity: 1; transition: opacity 0.5s ease-in-out; }
        .song-info { transition: opacity 0.3s ease; }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #1DB954;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for placeholder text color */
        ::placeholder { color: #737373; opacity: 1; }
        :-ms-input-placeholder { color: #737373; }
        ::-ms-input-placeholder { color: #737373; }
    </style>
</head>
<body>

    <!-- Container for switching between views -->
    <div id="app-container" class="h-screen w-full max-w-md mx-auto">

        <!-- Search View -->
        <div id="search-view" class="flex flex-col justify-center items-center h-full p-4 sm:p-6 md:p-8">
            <header class="text-center w-full mb-8">
                <div class="flex justify-center mb-6">
                    <svg role="img" height="80" width="80" aria-hidden="true" viewBox="0 0 167 167" fill="#1DB954"><path d="M83.5 0C37.5 0 0 37.5 0 83.5S37.5 167 83.5 167 167 129.5 167 83.5 129.5 0 83.5 0zM122 120.8c-1.4 2.5-4.4 3.2-6.8 1.8-19.5-12-44-14.7-73.4-8.1-2.8.6-5.5-1.2-6.1-4s1.2-5.5 4-6.1c31.9-7.1 58.6-4.1 80.1 9.2 2.4 1.5 3.2 4.5 1.8 6.8zM132.3 98.2c-1.7 3-5.5 4-8.5 2.3-22.3-13.7-56.2-17.7-83.1-9.7-3.3 1-6.7-1-7.6-4.2s1-6.7 4.2-7.6c30.1-8.7 67.2-4.2 92.9 11.2 3 1.7 4 5.5 2.3 8.5zM133.2 74.3c-2 3.6-6.6 4.8-10.2 2.8-25.7-15.5-68.7-19-98.2-10.5-4 .9-8.1-1.2-9-5.2s1.2-8.1 5.2-9c33.3-9.5 79.9-5.5 109.2 11.7 3.6 2 4.8 6.6 2.8 10.2z"></path></svg>
                </div>
                <h1 class="text-3xl font-bold mb-2">Cari Playlist Pengguna</h1>
                <p class="text-gray-400">Masukkan User ID untuk menemukan playlist.</p>
            </header>
            <main class="w-full flex flex-col items-center gap-4">
                <input id="search-input" type="text" placeholder="Ketik User ID..." class="w-full bg-[#282828] border border-gray-600 rounded-lg py-3 px-4 text-white focus:outline-none focus:ring-2 focus:ring-[#1DB954]">
                <button id="search-button" class="w-full bg-[#1DB954] text-white font-bold py-3 px-8 rounded-full transition-transform duration-200 hover:scale-105 active:scale-95 disabled:opacity-50 flex items-center justify-center">
                    <span id="search-button-text">Cari Playlist</span>
                    <div id="search-loader" class="loader ml-3 hidden"></div>
                </button>
                <div id="suggestions" class="w-full mt-2 text-center"></div>
            </main>
        </div>

        <!-- Playlist View (Initially Hidden) -->
        <div id="playlist-view" class="hidden flex-col justify-between items-center h-full py-8 sm:py-12 px-4 sm:px-6 md:px-8">
            <header class="text-center w-full">
                <div class="flex justify-center mb-4">
                     <svg role="img" height="60" width="60" aria-hidden="true" viewBox="0 0 167 167" fill="#1DB954"><path d="M83.5 0C37.5 0 0 37.5 0 83.5S37.5 167 83.5 167 167 129.5 167 83.5 129.5 0 83.5 0zM122 120.8c-1.4 2.5-4.4 3.2-6.8 1.8-19.5-12-44-14.7-73.4-8.1-2.8.6-5.5-1.2-6.1-4s1.2-5.5 4-6.1c31.9-7.1 58.6-4.1 80.1 9.2 2.4 1.5 3.2 4.5 1.8 6.8zM132.3 98.2c-1.7 3-5.5 4-8.5 2.3-22.3-13.7-56.2-17.7-83.1-9.7-3.3 1-6.7-1-7.6-4.2s1-6.7 4.2-7.6c30.1-8.7 67.2-4.2 92.9 11.2 3 1.7 4 5.5 2.3 8.5zM133.2 74.3c-2 3.6-6.6 4.8-10.2 2.8-25.7-15.5-68.7-19-98.2-10.5-4 .9-8.1-1.2-9-5.2s1.2-8.1 5.2-9c33.3-9.5 79.9-5.5 109.2 11.7 3.6 2 4.8 6.6 2.8 10.2z"></path></svg>
                </div>
                <p class="text-lg text-gray-300 px-4">Best place to share your playlist to your audience!</p>
            </header>
            <main class="w-full flex flex-col items-center gap-6 my-6">
                <div class="flex items-center gap-4 w-full px-2">
                    <div class="w-24 h-24 sm:w-28 sm:h-28 bg-[#282828] rounded-md flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                    </div>
                    <div class="flex flex-col justify-center overflow-hidden">
                        <h2 id="playlist-title" class="text-xl sm:text-2xl font-bold truncate">Liked Song</h2>
                        <p id="playlist-desc" class="text-sm text-gray-300 truncate">by User</p>
                    </div>
                </div>
                <div class="bg-[#181818] rounded-lg p-4 shadow-lg w-full">
                    <div id="song-list" class="overflow-y-auto pr-2"></div>
                </div>
            </main>
            <button id="test-luck-btn" class="bg-[#1DB954] text-white font-bold py-3 px-8 rounded-full transition-transform duration-200 hover:scale-105 active:scale-95 disabled:opacity-50 flex items-center justify-center">
                <span id="button-text">Loading...</span>
                <div id="button-loader" class="loader ml-3 hidden"></div>
            </button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Firebase Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCUmdnxFqYoi5Uj2809G0Pfd78nUdslG0M",
            authDomain: "pitch-perfect-magic.firebaseapp.com",
            databaseURL: "https://pitch-perfect-magic-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pitch-perfect-magic",
            storageBucket: "pitch-perfect-magic.appspot.com",
            messagingSenderId: "298805847665",
            appId: "1:298805847665:web:de8afedb832e38daeaddd0"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app = initializeApp(firebaseConfig);
        let auth = getAuth(app);
        let database = getDatabase(app);

        // --- State Variables ---
        let spectatorUid = null;
        let ownerId = null; 
        const songs = [ { title: "Monokrom", artist: "Tulus" }, { title: "As It Was", artist: "Harry Styles" }, { title: "Sisa Rasa", artist: "Mahalini" }, { title: "Blinding Lights", artist: "The Weeknd" }, { title: "Komang", artist: "Raim Laode" }, { title: "good 4 u", artist: "Olivia Rodrigo" }, { title: "Penjaga Hati", artist: "Nadhif Basalamah" }, { title: "Levitating", artist: "Dua Lipa" }, { title: "Runtuh", artist: "Feby Putri, Fiersa Besari" }, { title: "Heat Waves", artist: "Glass Animals" }, { title: "Bertaut", artist: "Nadin Amizah" }, { title: "Save Your Tears", artist: "The Weeknd" }, { title: "Sang Dewi", artist: "Lyodra, Andi Rianto" }, { title: "Stay", artist: "The Kid LAROI, Justin Bieber" }, { title: "Rayuan Perempuan Gila", artist: "Nadin Amizah" }, { title: "Watermelon Sugar", artist: "Harry Styles" }, { title: "Satu-Satu", artist: "Idgitaf" }, { title: "bad guy", artist: "Billie Eilish" }, { title: "Tak Ingin Usai", artist: "Keisya Levronka" }, { title: "Creepin'", artist: "Metro Boomin, The Weeknd, 21 Savage" }, { title: "Merasa Indah", artist: "Tiara Andini" }, { title: "Anti-Hero", artist: "Taylor Swift" }, { title: "Dengan Caraku", artist: "Arsy Widianto, Brisia Jodie" }, { title: "INDUSTRY BABY", artist: "Lil Nas X, Jack Harlow" }, { title: "Hati-Hati di Jalan", artist: "Tulus" }, { title: "Flowers", artist: "Miley Cyrus" }, { title: "Pilihan Yang Terbaik", artist: "Ziva Magnolya" }, { title: "Easy On Me", artist: "Adele" }, { title: "Diri", artist: "Tulus" }, { title: "Shape of You", artist: "Ed Sheeran" } ];
        
        // --- DOM Elements ---
        const searchView = document.getElementById('search-view');
        const playlistView = document.getElementById('playlist-view');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchButtonText = document.getElementById('search-button-text');
        const searchLoader = document.getElementById('search-loader');
        const suggestionsContainer = document.getElementById('suggestions');
        const songListContainer = document.getElementById('song-list');
        const luckButton = document.getElementById('test-luck-btn');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        
        let songItems = [];
        let forceItems = null;

        // --- UI State Functions ---
        function setLuckButtonLoading(isLoading, message = "Loading...") {
            luckButton.disabled = isLoading;
            buttonText.textContent = message;
            buttonLoader.classList.toggle('hidden', !isLoading);
        }
        function setSearchButtonLoading(isLoading, message = "Cari Playlist") {
            searchButton.disabled = isLoading;
            searchButtonText.textContent = message;
            searchLoader.classList.toggle('hidden', !isLoading);
        }
        
        // --- Core Functions ---
        function renderSongs() {
            songListContainer.innerHTML = '';
            songs.forEach((song, index) => {
                const songElement = document.createElement('div');
                songElement.className = 'song-item flex items-center p-3 rounded-md'; 
                songElement.innerHTML = `<div class="w-8 text-center text-gray-400"><span class="song-number">${index + 1}</span></div><div class="song-info flex-grow ml-4"><p class="font-bold text-white truncate">${song.title}</p><p class="text-sm text-gray-400 truncate">${song.artist}</p></div><div class="text-gray-400"><svg role="img" height="16" width="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor"><path d="M3 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm6.5 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zM16 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"></path></svg></div>`;
                songListContainer.appendChild(songElement);
            });
            songItems = document.querySelectorAll('.song-item');
        }

        function setListHeight() {
            if (songItems.length < 4 || songItems[0].offsetHeight === 0) {
                requestAnimationFrame(setListHeight);
                return;
            }
            let totalHeight = 0;
            for (let i = 0; i < 4; i++) totalHeight += songItems[i].offsetHeight;
            songListContainer.style.height = `${totalHeight}px`;
        }
        
        function handleForcedItemClick(event) {
            const spotifyLink = event.currentTarget.dataset.spotifyLink;
            if (spotifyLink && ownerId && spectatorUid) {
                songItems.forEach(item => { item.removeEventListener('click', handleForcedItemClick); item.style.cursor = 'default'; });
                setLuckButtonLoading(true, "Redirecting...");
                const spectatorChoicesRef = ref(database, `${ownerId}/spectatorChoices`);
                set(spectatorChoicesRef, { [spectatorUid]: spotifyLink })
                    .finally(() => { window.location.replace(spotifyLink); });
            }
        }

        async function initFirebaseAndAuth() {
            try {
                const userCredential = initialAuthToken ? await signInWithCustomToken(auth, initialAuthToken) : await signInAnonymously(auth);
                spectatorUid = userCredential.user.uid; 
                console.log("Authenticated successfully. Spectator UID:", spectatorUid);
            } catch (error) {
                console.error("Authentication failed:", error);
                suggestionsContainer.innerHTML = `<p class="text-red-400">Gagal melakukan autentikasi.</p>`;
            }
        }

        async function loadPlaylistData() {
            if (!ownerId) return;

            // Update UI with static title
            document.getElementById('playlist-title').textContent = "Liked Song";
            document.getElementById('playlist-desc').textContent = `by ${ownerId}`;

            setLuckButtonLoading(true, "Loading Playlist...");
            try {
                const forceItemsRef = ref(database, `${ownerId}/forceItems`);
                const snapshot = await get(forceItemsRef);
                const data = snapshot.val();
                if (data && Array.isArray(data) && data.length === 4) {
                    forceItems = data;
                    setLuckButtonLoading(false, "Test My Luck");
                } else {
                    console.error("Firebase data ('forceItems') is invalid.");
                    setLuckButtonLoading(false, "Config Error");
                }
            } catch (error) {
                console.error("Firebase read failed:", error);
                setLuckButtonLoading(false, "Cannot Load Data");
            }
        }

        async function findUserIds() {
            const query = searchInput.value.trim().toLowerCase();
            if (query.length < 2) {
                suggestionsContainer.innerHTML = `<p class="text-gray-400">Ketik minimal 2 karakter.</p>`;
                return;
            }

            setSearchButtonLoading(true, "Mencari...");
            suggestionsContainer.innerHTML = '';

            try {
                const useridsRef = ref(database, 'userids');
                const snapshot = await get(useridsRef);
                const userids = snapshot.val();
                
                if (!userids) {
                    suggestionsContainer.innerHTML = `<p class="text-red-400">Tidak ada data user id.</p>`;
                    return;
                }

                const matches = Object.keys(userids).filter(id => id.toLowerCase().includes(query));

                if (matches.length > 0) {
                    matches.forEach(id => {
                        const btn = document.createElement('button');
                        btn.textContent = id;
                        btn.dataset.userid = id;
                        btn.className = 'suggestion-item w-full text-left p-3 bg-[#282828] hover:bg-[#3e3e3e] rounded-lg mb-2 transition-colors';
                        suggestionsContainer.appendChild(btn);
                    });
                } else {
                    suggestionsContainer.innerHTML = `<p class="text-gray-400">User ID tidak ditemukan.</p>`;
                }
            } catch (error) {
                console.error("Error searching user IDs:", error);
                suggestionsContainer.innerHTML = `<p class="text-red-400">Gagal mencari user. Periksa koneksi/rules.</p>`;
            } finally {
                setSearchButtonLoading(false);
            }
        }
        
        function selectUser(selectedId) {
            ownerId = selectedId;
            searchView.classList.add('hidden');
            playlistView.classList.remove('hidden');
            playlistView.classList.add('flex');
            
            // Render songs and set heights for the new view
            renderSongs();
            setListHeight();
            window.addEventListener('resize', setListHeight);
            
            // Now load the data for this user
            loadPlaylistData();
        }

        // --- Main Application Logic & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initFirebaseAndAuth(); // Authenticate on page load
            searchButton.addEventListener('click', findUserIds);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') findUserIds();
            });
            suggestionsContainer.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('suggestion-item')) {
                    selectUser(e.target.dataset.userid);
                }
            });
        });

        luckButton.addEventListener('click', () => {
            if (!forceItems || !spectatorUid) return;

            setLuckButtonLoading(true, "Spinning...");

            songItems.forEach(item => {
                item.classList.add('info-hidden');
                item.classList.remove('info-visible', 'bg-green-700', 'bg-opacity-50', 'ring-2', 'ring-green-500'); 
            });
            
            const maxStartIndex = songs.length - 4;
            const randomStartIndex = Math.floor(Math.random() * (maxStartIndex + 1));
            
            let animationInterval = setInterval(() => {
                const randomScrollIndex = Math.floor(Math.random() * songs.length);
                songItems[randomScrollIndex].scrollIntoView({ behavior: 'auto', block: 'center' });
            }, 100);

            setTimeout(() => {
                clearInterval(animationInterval);
                songItems[randomStartIndex].scrollIntoView({ behavior: 'smooth', block: 'start' });

                setTimeout(() => {
                    for (let i = 0; i < 4; i++) {
                        const itemIndex = randomStartIndex + i;
                        const songItemElement = songItems[itemIndex];
                        const forcedItemData = forceItems[i];

                        songItemElement.querySelector('.song-info .font-bold').textContent = forcedItemData.title;
                        songItemElement.querySelector('.song-info .text-sm').textContent = forcedItemData.artist;
                        songItemElement.dataset.spotifyLink = forcedItemData.link;
                        songItemElement.style.cursor = 'pointer';
                        songItemElement.addEventListener('click', handleForcedItemClick);
                    }

                    songItems.forEach(item => item.classList.add('info-visible'));
                    setLuckButtonLoading(false, "Choose Your Fate");
                    luckButton.disabled = true;
                }, 700); 

            }, 2500); 
        });
    </script>
</body>
</html>
