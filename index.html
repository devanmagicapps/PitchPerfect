<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayShare : Share Your Spotify Playlist</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to mimic Spotify's look and feel */
        html, body {
            height: 100%;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; /* Spotify's dark background */
            color: #ffffff;
            /* Center the main content block */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; /* Needed for absolute positioning of header */
            overflow: hidden; /* Prevent potential scrollbars from absolute header */
        }

        /* Header is positioned absolutely at the top */
        .page-header {
            position: absolute;
            top: 8vh; /* Position near the top */
            left: 0;
            right: 0;
            width: 100%;
            max-width: 28rem; /* Corresponds to max-w-md */
            margin-left: auto;
            margin-right: auto;
        }

        /* Custom scrollbar to match the theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #535353;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b6b6b;
        }

        /* Class to hide song info during animation */
        .info-hidden .song-info {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        /* Class to show song info */
        .info-visible .song-info {
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
        
        .song-info {
            transition: opacity 0.3s ease;
        }
        
        /* Loading indicator styling */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #1DB954;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4">

    <!-- Header Section (positioned absolutely) -->
    <header class="page-header text-center">
        <div class="flex justify-center mb-4">
            <svg role="img" height="60" width="60" aria-hidden="true" viewBox="0 0 167 167" fill="#1DB954">
                <path d="M83.5 0C37.5 0 0 37.5 0 83.5S37.5 167 83.5 167 167 129.5 167 83.5 129.5 0 83.5 0zM122 120.8c-1.4 2.5-4.4 3.2-6.8 1.8-19.5-12-44-14.7-73.4-8.1-2.8.6-5.5-1.2-6.1-4s1.2-5.5 4-6.1c31.9-7.1 58.6-4.1 80.1 9.2 2.4 1.5 3.2 4.5 1.8 6.8zM132.3 98.2c-1.7 3-5.5 4-8.5 2.3-22.3-13.7-56.2-17.7-83.1-9.7-3.3 1-6.7-1-7.6-4.2s1-6.7 4.2-7.6c30.1-8.7 67.2-4.2 92.9 11.2 3 1.7 4 5.5 2.3 8.5zM133.2 74.3c-2 3.6-6.6 4.8-10.2 2.8-25.7-15.5-68.7-19-98.2-10.5-4 .9-8.1-1.2-9-5.2s1.2-8.1 5.2-9c33.3-9.5 79.9-5.5 109.2 11.7 3.6 2 4.8 6.6 2.8 10.2z"></path>
            </svg>
        </div>
        <p class="text-lg text-gray-300 px-4">
            Best place to share your spotify playlist to your audience!
        </p>
    </header>

    <!-- Main Content (centered vertically and horizontally) -->
    <main class="w-full max-w-md mx-auto flex flex-col items-center">
        
        <!-- Song List Container -->
        <div class="bg-[#181818] rounded-lg p-4 shadow-lg w-full mb-8">
            <!-- Scrollable list: height is now set by JavaScript -->
            <div id="song-list" class="overflow-y-auto pr-2">
                <!-- Song items will be injected by JavaScript -->
            </div>
        </div>
        
        <!-- Action Button -->
        <button id="test-luck-btn" class="bg-[#1DB954] text-white font-bold py-3 px-8 rounded-full transition-transform duration-200 hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center">
            <span id="button-text">Loading...</span>
            <div id="button-loader" class="loader ml-3 hidden"></div>
        </button>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // --- Firebase Globals & Initialization ---
        
        // Konfigurasi Firebase Default sebagai cadangan
        const defaultFirebaseConfig = {
            apiKey: "AIzaSyCUmdnxFqYoi5Uj2809G0Pfd78nUdslG0M",
            authDomain: "pitch-perfect-magic.firebaseapp.com",
            databaseURL: "https://pitch-perfect-magic-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pitch-perfect-magic",
            storageBucket: "pitch-perfect-magic.appspot.com",
            messagingSenderId: "298805847665",
            appId: "1:298805847665:web:de8afedb832e38daeaddd0"
        };
        
        // PENTING: Menggunakan variabel global lingkungan untuk konfigurasi Firebase
        const envFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Prioritaskan konfigurasi lingkungan, jika tidak ada gunakan default
        const firebaseConfig = envFirebaseConfig || defaultFirebaseConfig;

        let app;
        let auth;
        let database;
        
        // Inisialisasi Firebase (selalu berjalan karena config selalu ada)
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        database = getDatabase(app);

        // --- NEW: State Variable for Spectator UID (Authenticated User) ---
        let spectatorUid = null;
        // userId from URL is the playlist Owner's ID
        let ownerId = null; 

        // --- Song List (30 songs) ---
        const songs = [
            { title: "Monokrom", artist: "Tulus" },
            { title: "As It Was", artist: "Harry Styles" },
            { title: "Sisa Rasa", artist: "Mahalini" },
            { title: "Blinding Lights", artist: "The Weeknd" },
            { title: "Komang", artist: "Raim Laode" },
            { title: "good 4 u", artist: "Olivia Rodrigo" },
            { title: "Penjaga Hati", artist: "Nadhif Basalamah" },
            { title: "Levitating", artist: "Dua Lipa" },
            { title: "Runtuh", artist: "Feby Putri, Fiersa Besari" },
            { title: "Heat Waves", artist: "Glass Animals" },
            { title: "Bertaut", artist: "Nadin Amizah" },
            { title: "Save Your Tears", artist: "The Weeknd" },
            { title: "Sang Dewi", artist: "Lyodra, Andi Rianto" },
            { title: "Stay", artist: "The Kid LAROI, Justin Bieber" },
            { title: "Rayuan Perempuan Gila", artist: "Nadin Amizah" },
            { title: "Watermelon Sugar", artist: "Harry Styles" },
            { title: "Satu-Satu", artist: "Idgitaf" },
            { title: "bad guy", artist: "Billie Eilish" },
            { title: "Tak Ingin Usai", artist: "Keisya Levronka" },
            { title: "Creepin'", artist: "Metro Boomin, The Weeknd, 21 Savage" },
            { title: "Merasa Indah", artist: "Tiara Andini" },
            { title: "Anti-Hero", artist: "Taylor Swift" },
            { title: "Dengan Caraku", artist: "Arsy Widianto, Brisia Jodie" },
            { title: "INDUSTRY BABY", artist: "Lil Nas X, Jack Harlow" },
            { title: "Hati-Hati di Jalan", artist: "Tulus" },
            { title: "Flowers", artist: "Miley Cyrus" },
            { title: "Pilihan Yang Terbaik", artist: "Ziva Magnolya" },
            { title: "Easy On Me", artist: "Adele" },
            { title: "Diri", artist: "Tulus" },
            { title: "Shape of You", artist: "Ed Sheeran" }
        ];

        // --- DOM Elements & State Variables ---
        const songListContainer = document.getElementById('song-list');
        const luckButton = document.getElementById('test-luck-btn');
        const buttonText = document.getElementById('button-text');
        const buttonLoader = document.getElementById('button-loader');
        
        let songItems = [];
        let forceItems = null; // Will hold the 4 custom songs from Firebase

        // --- Utility Functions ---
        function setLoadingState(isLoading, message = "Loading...") {
            luckButton.disabled = isLoading;
            buttonText.textContent = message;
            if (isLoading) {
                buttonLoader.classList.remove('hidden');
                luckButton.style.paddingLeft = '3rem'; // Adjust padding for loader
                luckButton.style.paddingRight = '3rem'; 
            } else {
                buttonLoader.classList.add('hidden');
                luckButton.style.paddingLeft = ''; // Reset padding
                luckButton.style.paddingRight = '';
            }
        }

        // --- Core Functions ---
        function renderSongs() {
            songListContainer.innerHTML = '';
            songs.forEach((song, index) => {
                const songElement = document.createElement('div');
                // Menggunakan p-2.5 atau p-3 agar tinggi tiap baris sedikit bertambah
                songElement.className = 'song-item flex items-center p-3 rounded-md'; 
                songElement.innerHTML = `
                    <div class="w-8 text-center text-gray-400">
                        <span class="song-number">${index + 1}</span>
                    </div>
                    <div class="song-info flex-grow ml-4">
                        <p class="font-bold text-white truncate">${song.title}</p>
                        <p class="text-sm text-gray-400 truncate">${song.artist}</p>
                    </div>
                    <div class="text-gray-400">
                        <svg role="img" height="16" width="16" aria-hidden="true" viewBox="0 0 16 16" fill="currentColor"><path d="M3 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm6.5 0a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zM16 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"></path></svg>
                    </div>
                `;
                songListContainer.appendChild(songElement);
            });
            songItems = document.querySelectorAll('.song-item');
        }

        function setListHeight() {
            if (songItems.length >= 4) {
                let totalHeight = 0;
                // Mengukur tinggi 4 item pertama
                for (let i = 0; i < 4; i++) {
                    totalHeight += songItems[i].offsetHeight;
                }
                // Ditingkatkan sedikit untuk memberikan padding visual
                songListContainer.style.height = `${totalHeight + 8}px`; 
            }
        }
        
        // --- Click Handler for the Final Items ---
        function handleForcedItemClick(event) {
            const songItem = event.currentTarget;
            const spotifyLink = songItem.dataset.spotifyLink;

            if (spotifyLink && ownerId && spectatorUid) {
                // Disable further clicks
                songItems.forEach(item => {
                    item.removeEventListener('click', handleForcedItemClick);
                    item.style.cursor = 'default';
                    // Hapus highlight (jika ada, meskipun seharusnya tidak ada)
                    item.classList.remove('bg-green-700', 'bg-opacity-50', 'ring-2', 'ring-green-500'); 
                });

                setLoadingState(true, "Redirecting...");

                // Gunakan ownerId (path) dan spectatorUid (key di bawah spectatorChoices)
                const updates = {};
                updates[`${ownerId}/spectatorChoices/${spectatorUid}`] = spotifyLink;
                
                update(ref(database), updates)
                    .then(() => { 
                        window.location.replace(spotifyLink); 
                    })
                    .catch(error => {
                        console.error("Error writing to Firebase:", error);
                        // Redirect anyway even if database write fails
                        window.location.replace(spotifyLink);
                    });
            }
        }

        /**
         * Melakukan login anonim atau menggunakan custom token yang disediakan, 
         * dan menetapkan spectatorUid.
         */
        async function initFirebaseAndAuth() {
            setLoadingState(true, "Authenticating...");
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                // Setelah promise login selesai, auth.currentUser.uid dipastikan valid
                spectatorUid = auth.currentUser.uid; 
                console.log("Authenticated successfully. Spectator UID:", spectatorUid);
                
                // Panggil fungsi pemuatan data di sini, setelah autentikasi sukses.
                await loadPlaylistData(); 
            } catch (error) {
                console.error("Authentication failed:", error);
                setLoadingState(false, "Auth Error");
            }
        }

        async function loadPlaylistData() {
            // Periksa Owner ID
            const urlParams = new URLSearchParams(window.location.search);
            ownerId = urlParams.get('id');

            if (!ownerId) {
                console.error("Owner ID not found in URL (?id=...).");
                setLoadingState(false, "Owner ID Missing");
                return;
            }

            setLoadingState(true, "Loading Playlist...");
            try {
                // JALUR DATA: ${ownerId}/forceItems.
                const snapshot = await get(ref(database, `${ownerId}/forceItems`));
                const data = snapshot.val();

                if (data && Array.isArray(data) && data.length === 4) {
                    forceItems = data;
                    setLoadingState(false, "Test My Luck");
                } else {
                    console.error("Firebase data ('forceItems') is missing, not an array, or not of length 4. Check ownerId and Firebase rules.");
                    setLoadingState(false, "Config Error");
                }
            } catch (error) {
                // Tangani error jika pembacaan gagal karena masalah rules atau koneksi.
                console.error("Firebase read failed (likely permission error):", error);
                setLoadingState(false, "Cannot Load Data");
            }
        }

        // --- Main Application Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSongs();
            setListHeight();
            window.addEventListener('resize', setListHeight);
            
            // Start the authentication and data loading process
            initFirebaseAndAuth();
        });

        // --- Button Click Event Listener ---
        luckButton.addEventListener('click', () => {
            if (!forceItems || !spectatorUid) return;

            setLoadingState(true, "Spinning...");

            songItems.forEach(item => {
                item.classList.add('info-hidden');
                item.classList.remove('info-visible');
                // Hapus highlight dari semua item sebelum animasi dimulai
                item.classList.remove('bg-green-700', 'bg-opacity-50', 'ring-2', 'ring-green-500'); 
            });
            
            const maxStartIndex = songs.length - 4;
            const randomStartIndex = Math.floor(Math.random() * (maxStartIndex + 1));
            
            let animationInterval = setInterval(() => {
                const randomScrollIndex = Math.floor(Math.random() * songs.length);
                songItems[randomScrollIndex].scrollIntoView({ behavior: 'auto', block: 'center' });
            }, 100);

            setTimeout(() => {
                clearInterval(animationInterval);
                songItems[randomStartIndex].scrollIntoView({ behavior: 'smooth', block: 'start' });

                setTimeout(() => {
                    // Update the 4 songs with forced data
                    for (let i = 0; i < 4; i++) {
                        const itemIndex = randomStartIndex + i;
                        const songItemElement = songItems[itemIndex];
                        const forcedItemData = forceItems[i];

                        const titleEl = songItemElement.querySelector('.song-info .font-bold');
                        const artistEl = songItemElement.querySelector('.song-info .text-sm');

                        titleEl.textContent = forcedItemData.title;
                        artistEl.textContent = forcedItemData.artist;

                        songItemElement.dataset.spotifyLink = forcedItemData.link;
                        songItemElement.style.cursor = 'pointer';
                        songItemElement.addEventListener('click', handleForcedItemClick);
                        
                        // BARIS INI DIHAPUS: songItemElement.classList.add('bg-green-700', 'bg-opacity-50', 'ring-2', 'ring-green-500');
                    }

                    // Show info and prepare for click
                    songItems.forEach(item => {
                        item.classList.remove('info-hidden');
                        item.classList.add('info-visible');
                    });
                    setLoadingState(false, "Choose Your Fate");
                    luckButton.disabled = true; // Disable main button, only allow clicking the songs
                }, 700); 

            }, 2500); 
        });

    </script>

</body>
</html>
